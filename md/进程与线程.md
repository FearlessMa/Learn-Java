# è¿›ç¨‹ä¸çº¿ç¨‹

* åœ¨javaè¯­è¨€ä¸­æœ€å¤§çš„ç‰¹ç‚¹æ˜¯æ”¯æŒå¤šçº¿ç¨‹çš„å¼€å‘

    * å¤šè¿›ç¨‹ï¼š åŒä¸€æ—¶é—´æ®µå†…å¯æ‰§è¡Œå¤šä¸ªç¨‹åº
    * çº¿ç¨‹ ï¼š çº¿ç¨‹æ˜¯è¿›ç¨‹åŸºç¡€ä¸Šåˆ’åˆ†çš„æ›´å°çš„ç¨‹åºå•å…ƒï¼Œçº¿ç¨‹æ˜¯åœ¨è¿›ç¨‹åŸºç¡€ä¸Šåˆ›å»ºå¹¶ä¸”ä½¿ç”¨çš„ã€‚çº¿ç¨‹çš„å¯åŠ¨é€Ÿåº¦è¦æ¯”è¿›ç¨‹å¿«ï¼Œå¤šçº¿ç¨‹å¤„ç†å¹¶å‘è¯·æ±‚çš„æ—¶å€™ï¼Œè¦é«˜äºè¿›ç¨‹çš„æ‰§è¡Œ

## Threadç±»å®ç°å¤šçº¿ç¨‹

* javaä¹‹ä¸­å®ç°å¤šçº¿ç¨‹ï¼Œéœ€è¦ä¸“é—¨çš„çº¿ç¨‹ä¸»ä½“ç±»ï¼Œå¿…é¡»å®ç°ç‰¹å®šçš„æ¥å£æˆ–ç»§æ‰¿ç‰¹å®šçš„çˆ¶ç±»æ‰å¯ä»¥å®Œæˆ

* ç»§æ‰¿Threadç±»å®ç°å¤šçº¿ç¨‹
    * java.lang.Thread çš„ç¨‹åºç±»ï¼Œåªè¦ä¸€ä¸ªç±»ç»§æ‰¿äº†è¯¥ç±»ï¼Œå°±ä¸ºçº¿ç¨‹çš„ä¸»ä½“ç±»ã€‚
    * éœ€è¦é‡å†™runæ–¹æ³•ï¼Œçº¿ç¨‹çš„ä¸»æ–¹æ³•
        * public void runâ€‹()

```java

class MyThread extends Thread { // çº¿ç¨‹çš„ä¸»ä½“ç±»
    private String title;

    public MyThread(String title) {
        this.title = title;
    }

    @Override
    public void run() { // çº¿ç¨‹çš„ä¸»ä½“æ–¹æ³•
        // super.run();
        for (int i = 0; i < 5; i++) {
            System.out.println(this.title + "i=" + i);
        }
    }
}

public class JavaDemo35 {
    public static void main(String[] args) {
        new MyThread("çº¿ç¨‹A").run();
        new MyThread("çº¿ç¨‹B").run();
        new MyThread("çº¿ç¨‹C").run();
        // è°ƒç”¨runçº¿æ€§æ‰§è¡Œï¼Œå¹¶æ²¡æœ‰äº¤æ›¿æ‰§è¡Œ
        // çº¿ç¨‹Ai=0
        // çº¿ç¨‹Ai=1
        // çº¿ç¨‹Ai=2
        // çº¿ç¨‹Ai=3
        // çº¿ç¨‹Ai=4
        // çº¿ç¨‹Bi=0
        // çº¿ç¨‹Bi=1
        // çº¿ç¨‹Bi=2
        // çº¿ç¨‹Bi=3
        // çº¿ç¨‹Bi=4
        // çº¿ç¨‹Ci=0
        // çº¿ç¨‹Ci=1
        // çº¿ç¨‹Ci=2
        // çº¿ç¨‹Ci=3
        // çº¿ç¨‹Ci=4
        new MyThread("çº¿ç¨‹A").start();
        new MyThread("çº¿ç¨‹B").start();
        new MyThread("çº¿ç¨‹C").start();
        // è°ƒç”¨start å¤šçº¿ç¨‹å¯åŠ¨
        // çº¿ç¨‹Ci=0
        // çº¿ç¨‹Ci=1
        // çº¿ç¨‹Bi=0
        // çº¿ç¨‹Bi=1
        // çº¿ç¨‹Ai=0
        // çº¿ç¨‹Ai=1
        // çº¿ç¨‹Bi=2
        // çº¿ç¨‹Ci=2
        // çº¿ç¨‹Ci=3
        // çº¿ç¨‹Bi=3
        // çº¿ç¨‹Ai=2
        // çº¿ç¨‹Ai=3
        // çº¿ç¨‹Bi=4
        // çº¿ç¨‹Ci=4
        // çº¿ç¨‹Ai=4

    }
}
```

* æ­£å¸¸æƒ…å†µä¸‹è¦ä½¿ç”¨ä¸€ä¸ªç±»ä¸­æ–¹æ³•ï¼Œéœ€è¦äº§ç”Ÿå®ä¾‹åŒ–å¯¹è±¡è€Œåå»è°ƒç”¨ç±»ä¸­æä¾›çš„æ–¹æ³•ã€‚runæ–¹æ³•æ˜¯ä¸èƒ½å¤Ÿè¢«ç›´æ¥è°ƒç”¨çš„ã€‚å› ä¸ºæ¶‰åŠåˆ°æ“ä½œç³»ç»Ÿçš„èµ„æºè°ƒåº¦é—®é¢˜ï¼Œè¦æƒ³å¯åŠ¨å¤šçº¿æ€§å¿…é¡»ä½¿ç”¨startæ–¹æ³•å®Œæˆã€‚
    * public void startâ€‹()

* è™½ç„¶è°ƒç”¨çš„æ˜¯startæ–¹æ³•ä½†æ˜¯æœ€ç»ˆæ‰§è¡Œçš„æ˜¯runæ–¹æ³•ï¼Œæ‰€æœ‰çº¿ç¨‹çš„å¯¹è±¡æ˜¯äº¤æ›¿æ‰§è¡Œçš„

### ä¸ºä»€ä¹ˆå¤šçº¿ç¨‹çš„å¯åŠ¨ä¸ç”¨runæ–¹æ³•ï¼Œè€Œæ˜¯ç”¨Threadç±»ä¸­çš„startæ–¹æ³•

* æ‰“å¼€startæºä»£ç æŸ¥çœ‹

```java
public synchronized void start() {
        if (threadStatus != 0) //åˆ¤æ–­çº¿ç¨‹çš„çŠ¶æ€
            throw new IllegalThreadStateException(); //æŠ›å‡ºå¼‚å¸¸

        group.add(this);

        boolean started = false;
        try {
            start0(); // startæ–¹æ³•é‡Œè°ƒç”¨start0æ–¹æ³•
            started = true;
        } finally {
            try {
                if (!started) {
                    group.threadStartFailed(this);
                }
            } catch (Throwable ignore) {
            }
        }
    }
    private native void start0(); //åªå®šä¹‰äº†æ–¹æ³•åç§° å’Œ ä½¿ç”¨nativeä¿®é¥°

```

* å‘ç°æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ç±»å¯¹è±¡ IllegalThreadStateExceptionï¼Œä½†æ˜¯æ•´ä¸ªç¨‹åºå¹¶æ²¡æœ‰throwsæ˜ç¡®çš„try...catchå¼‚å¸¸å¤„ç†ï¼Œè¯¥å¼‚å¸¸ä¸€å®šæ˜¯runTimeExceptionçš„å­ç±»ï¼Œæ²¡ä¸€ä¸ªçº¿ç¨‹ç±»å¯¹è±¡åªå…è®¸å¯åŠ¨ä¸€æ¬¡ï¼Œå¦‚æœé‡å¤å¯åŠ¨å°±æŠ›å‡ºæ¬¡å¼‚å¸¸
* ğŸŒ°

```java
MyThread mt = new MyThread("test");
        mt.start();
        mt.start();

//      Exception in thread "main" java.lang.IllegalThreadStateException
// 	at java.base/java.lang.Thread.start(Thread.java:794)
// 	at JavaDemo35.main(JavaDemo35.java:25)
// testi=0
// testi=1
// testi=2
// testi=3
// testi=4
```

* åœ¨javaç¨‹åºæ‰§è¡Œå½“ä¸­è€ƒè™‘åˆ°äº†ä¸åŒå±‚æ¬¡å¼€å‘è€…çš„éœ€æ±‚ï¼Œæ‰€ä»¥å…¶æ”¯æŒæœ‰æœ¬åœ°çš„æ“ä½œç³»ç»Ÿå‡½æ•°è°ƒç”¨ï¼Œè€Œè¿™é¡¹æŠ€æœ¯å°±è¢«ç§°ä¸ºJNI(Java Native Interface)æŠ€æœ¯ï¼Œä½†æ˜¯javaå¼€å‘è¿‡ç¨‹ä¸­ä¸æ¨èä½¿ç”¨ï¼Œåˆ©ç”¨è¿™æ ·çš„æŠ€æœ¯å¯ä»¥ä½¿ç”¨æ“ä½œç³»ç»Ÿçš„åº•å±‚å‡½æ•°è¿›ç¨‹ä¸€äº›ç‰¹æ®Šçš„å¤„ç†ï¼Œè€Œåœ¨Threadç±»ä¸­æä¾›çš„start0æ–¹æ³•å°±è¡¨ç¤ºéœ€è¦å°†æ­¤æ–¹æ³•ä¾èµ–äºä¸åŒçš„æ“ä½œç³»ç»Ÿå®ç°

![](../img/thread.png)

* ä»»ä½•æƒ…å†µä¸‹ï¼Œåªè¦å®šä¹‰äº†å¤šçº¿ç¨‹ï¼Œå¤šçº¿ç¨‹çš„å¯åŠ¨åªæœ‰ä¸€ç§æ–¹æ¡ˆï¼šThreadç±»ä¸­çš„start()æ–¹æ³•

## Runnableæ¥å£å®ç°å¤šçº¿ç¨‹

* ç”±äºç»§æ‰¿ä¼šæœ‰å•ç»§æ‰¿å±€é™ï¼Œjavaé‡Œåˆæä¾›ç¬¬äºŒç§å¤šçº¿ç¨‹ä¸»ä½“å®šä¹‰ç»“æ„
    * java.lang.Runnableæ¥å£

    ```java
        @FunctionalInterface
        public interface Runnable
    ```

* ğŸŒ°

```java
// @FunctionalInterface //jdk1.8ä¹‹åå°±å˜ä¸ºäº†å‡½æ•°å¼æ¥å£
// public interface Runnable{
// @Override
// public void run();
// }

public class JavaDemo35 {
    public static void main(String[] args) {
        Runnable rn = () -> {//çº¿ç¨‹æ–¹æ³•ä¸»ä½“
            for (int i = 0; i < 5; i++) {
                System.out.println("i=" + i);
            }
        };
        rn.run();
        // i=0
        // i=1
        // i=2
        // i=3
        // i=4
    }
}
```

* ç”±äºä¸å†ç»§æ‰¿Threadçˆ¶ç±»ï¼Œå°±æ²¡æœ‰startæ–¹æ³•äº†ï¼Œå¦‚æœä¸ä½¿ç”¨startæ–¹æ³•æ— æ³•è¿›è¡Œå¤šçº¿ç¨‹å¯åŠ¨ã€‚ä½†æ˜¯Threadç±»çš„æ„é€ æ–¹æ³•å¯ä»¥æ¥æ”¶Runnable
    * public Threadâ€‹(Runnable target)

```java

class MyThread implements Runnable { // çº¿ç¨‹çš„ä¸»ä½“ç±»
    private String title;

    public MyThread(String title) {
        this.title = title;
    }

    @Override
    public void run() { // çº¿ç¨‹çš„ä¸»ä½“æ–¹æ³•
        // super.run();
        for (int i = 0; i < 5; i++) {
            System.out.println(this.title + "i=" + i);
        }
    }
}

// @FunctionalInterface //jdk1.8ä¹‹åå°±å˜ä¸ºäº†å‡½æ•°å¼æ¥å£
// public interface Runnable{
// @Override
// public void run();
// }

public class JavaDemo35 {
    public static void main(String[] args) {
        new Thread(new MyThread("çº¿ç¨‹A")).start();
        new Thread(new MyThread("çº¿ç¨‹B")).start();
        new Thread(new MyThread("çº¿ç¨‹C")).start();
        // çº¿ç¨‹Bi=0
        // çº¿ç¨‹Bi=1
        // çº¿ç¨‹Ci=0
        // çº¿ç¨‹Ai=0
        // çº¿ç¨‹Ai=1
        // çº¿ç¨‹Ci=1
        // çº¿ç¨‹Bi=2
        // çº¿ç¨‹Ci=2
        // çº¿ç¨‹Ci=3
        // çº¿ç¨‹Ai=2
        // çº¿ç¨‹Ci=4
        // çº¿ç¨‹Bi=3
        // çº¿ç¨‹Ai=3
        // çº¿ç¨‹Bi=4
        // çº¿ç¨‹Ai=4

    }
}

```

* è¿™ä¸ªæ—¶å€™çš„å®ç°åªæ˜¯å®ç°äº†Runnableçš„æ¥å£ï¼Œæ‰€ä»¥æ­¤çº¿ç¨‹ç±»çš„ä¸»ä½“ä¸Šä¸å†æœ‰å•ç»§æ‰¿çš„å±€é™ï¼Œè¿™æ ·çš„è®¾è®¡æ‰æ˜¯ä¸€ä¸ªæ ‡å‡†å‹çš„è®¾è®¡

* å¯ä»¥å‘ç° ä»jdk1.8å¼€å§‹ Runnableä½¿ç”¨äº†å‡½æ•°å¼çš„æ¥å£å®šä¹‰ï¼Œå¯ä»¥ç›´æ¥åˆ©ç”¨lamda

```java
for (int x = 0; x < 3; x++) {
            String title = "çº¿ç¨‹-" + x;
            Runnable rn = new Runnable() {
                @Override
                public void run() {
                    for (int i = 0; i < 5; i++) {
                        System.out.println(title + "i=" + i);
                    }
                }
            };
            new Thread(rn).start();
        }
        // çº¿ç¨‹-1i=0
        // çº¿ç¨‹-1i=1
        // çº¿ç¨‹-1i=2
        // çº¿ç¨‹-2i=0
        // çº¿ç¨‹-0i=0
        // çº¿ç¨‹-2i=1
        // çº¿ç¨‹-2i=2
        // çº¿ç¨‹-1i=3
        // çº¿ç¨‹-2i=3
        // çº¿ç¨‹-0i=1
        // çº¿ç¨‹-2i=4
        // çº¿ç¨‹-1i=4
        // çº¿ç¨‹-0i=2
        // çº¿ç¨‹-0i=3
        // çº¿ç¨‹-0i=4
```

* å¤šçº¿ç¨‹ä¼˜å…ˆè€ƒè™‘Runnableå®ç°ï¼Œæ°¸è¿œæ˜¯Threadç±»å¯åŠ¨å¤šçº¿ç¨‹ã€‚